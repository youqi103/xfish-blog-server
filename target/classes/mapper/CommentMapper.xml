<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.youqi.usercenter.mapper.CommentMapper">

    <!-- 分页查询评论列表（包含关联信息） -->
    <select id="selectCommentVOPage" resultType="com.youqi.usercenter.model.vo.CommentVO">
        SELECT
            c.id,
            c.article_id,
            c.user_id,
            c.parent_id,
            c.content,
            c.status,
            c.ip_address,
            c.user_agent,
            c.created_at as createTime,
            c.updated_at as updateTime,
            a.title as articleTitle,
            u.nickname as userName,
            u.nickname as authorName,
            u.email as authorEmail,
            u.avatar as authorAvatar,
            (SELECT COUNT(*) FROM likes WHERE target_type = 'comment' AND target_id = c.id) as likeCount,
            (SELECT COUNT(*) FROM comments WHERE parent_id = c.id) as replyCount,
            0 as reportCount
        FROM comments c
        LEFT JOIN articles a ON c.article_id = a.id
        LEFT JOIN users u ON c.user_id = u.id
        <where>
            <if test="articleId != null">
                AND c.article_id = #{articleId}
            </if>
            <if test="parentId != null">
                AND c.parent_id = #{parentId}
            </if>
            <if test="status != null and status != ''">
                <choose>
                    <when test="status == 0">
                        AND c.status = 'pending'
                    </when>
                    <when test="status == 1">
                        AND c.status = 'approved'
                    </when>
                    <when test="status == 2">
                        AND c.status = 'rejected'
                    </when>
                    <when test="status == 3">
                        AND c.status = 'spam'
                    </when>
                    <otherwise>
                        AND c.status = #{status}
                    </otherwise>
                </choose>
            </if>
            <if test="userId != null">
                AND c.user_id = #{userId}
            </if>
        </where>
        ORDER BY c.created_at DESC
    </select>

    <!-- 按日期范围统计评论趋势 -->
    <select id="selectCommentTrend" resultType="com.youqi.usercenter.model.vo.CommentTrendVO">
        SELECT
            DATE_FORMAT(created_at, '%Y-%m-%d') as date,
            COUNT(*) as comments
        FROM comments
        WHERE created_at >= #{startDate}
          AND created_at &lt;= #{endDate}
        GROUP BY DATE_FORMAT(created_at, '%Y-%m-%d')
        ORDER BY date ASC
    </select>

    <!-- 统计今日评论数 -->
    <select id="selectTodayCommentCount" resultType="java.lang.Long">
        SELECT COUNT(*)
        FROM comments
        WHERE DATE(created_at) = CURDATE()
    </select>

    <!-- 统计昨日评论数 -->
    <select id="selectYesterdayCommentCount" resultType="java.lang.Long">
        SELECT COUNT(*)
        FROM comments
        WHERE DATE(created_at) = DATE_SUB(CURDATE(), INTERVAL 1 DAY)
    </select>

    <!-- 统计总评论数 -->
    <select id="selectTotalCommentCount" resultType="java.lang.Long">
        SELECT COUNT(*)
        FROM comments
    </select>

    <!-- 统计评论状态分布 -->
    <select id="selectCommentStatusDistribution" resultType="com.youqi.usercenter.model.vo.CommentStatusDistributionVO">
        SELECT
            CASE status
                WHEN 'pending' THEN '待审核'
                WHEN 'approved' THEN '已发布'
                WHEN 'rejected' THEN '已拒绝'
                WHEN 'spam' THEN '已删除'
                ELSE status
            END as type,
            COUNT(*) as value
        FROM comments
        GROUP BY status
    </select>

    <!-- 统计评论小时分布 -->
    <select id="selectCommentHourDistribution" resultType="com.youqi.usercenter.model.vo.CommentHourDistributionVO">
        SELECT
            HOUR(created_at) as hour,
            COUNT(*) as count
        FROM comments
        WHERE created_at >= #{startDate}
          AND created_at &lt;= #{endDate}
        GROUP BY HOUR(created_at)
        ORDER BY hour ASC
    </select>

    <!-- 获取热门评论文章 -->
    <select id="selectHotArticlesByComments" resultType="com.youqi.usercenter.model.vo.HotArticleVO">
        SELECT
            a.id,
            a.title,
            a.comment_count as commentCount
        FROM articles a
        WHERE a.status = '1'
          AND a.comment_count > 0
        ORDER BY a.comment_count DESC
        LIMIT #{limit}
    </select>

    <!-- 统计活跃用户数（近期有评论的用户） -->
    <select id="selectActiveUserCount" resultType="java.lang.Long">
        SELECT COUNT(DISTINCT user_id)
        FROM comments
        WHERE created_at >= DATE_SUB(CURDATE(), INTERVAL 7 DAY)
    </select>

    <!-- 统计昨日活跃用户数 -->
    <select id="selectYesterdayActiveUserCount" resultType="java.lang.Long">
        SELECT COUNT(DISTINCT user_id)
        FROM comments
        WHERE created_at >= DATE_SUB(CURDATE(), INTERVAL 8 DAY)
          AND created_at &lt; DATE_SUB(CURDATE(), INTERVAL 7 DAY)
    </select>

</mapper>
